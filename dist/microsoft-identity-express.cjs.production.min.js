"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,r=require("@azure/msal-common"),n=e(require("express")),o=require("@azure/msal-node"),i=require("crypto"),s=e(require("axios")),a=require("@azure/identity"),c=require("@azure/keyvault-certificates"),u=require("@azure/keyvault-secrets");function p(){p=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var o=Object.create((t&&t.prototype instanceof h?t:h).prototype),i=new R(n||[]);return o._invoke=function(e,t,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var a=w(s,r);if(a){if(a===l)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,i),o}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function h(){}function f(){}function d(){}var g={};a(g,o,(function(){return this}));var v=Object.getPrototypeOf,E=v&&v(v(k([])));E&&E!==t&&r.call(E,o)&&(g=E);var y=d.prototype=h.prototype=Object.create(g);function m(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){var n;this._invoke=function(o,i){function s(){return new t((function(n,s){!function n(o,i,s,a){var c=u(e[o],e,i);if("throw"!==c.type){var p=c.arg,l=p.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(l).then((function(e){p.value=e,s(p)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}(o,i,n,s)}))}return n=n?n.then(s,s):s()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function C(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function k(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:A}}function A(){return{value:void 0,done:!0}}return f.prototype=d,a(y,"constructor",d),a(d,"constructor",f),f.displayName=a(d,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,s,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},m(S.prototype),a(S.prototype,i,(function(){return this})),e.AsyncIterator=S,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var s=new S(c(t,r,n,o),i);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},m(y),a(y,s,"Generator"),a(y,o,(function(){return this})),a(y,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=k,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(C),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var a=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(a&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),C(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:k(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function l(e,t,r,n,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}function h(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var i=e.apply(t,r);function s(e){l(i,n,o,s,a,"next",e)}function a(e){l(i,n,o,s,a,"throw",e)}s(void 0)}))}}function f(){return(f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function d(e,t){var r,n;e.prototype=Object.create(t.prototype),e.prototype.constructor=e,r=e,n=t,(Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(r,n)}function g(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}!function(e){e.SIGN_IN="sign_in",e.SIGN_OUT="sign_out",e.ACQUIRE_TOKEN="acquire_token"}(t||(t={}));var v,E={COMMON:"common",ORGANIZATIONS:"organizations",CONSUMERS:"consumers"};!function(e){e.SECRET="clientSecret",e.CERTIFICATE="clientCertificate"}(v||(v={}));var y,m=["openid","profile","email","offline_access"],S={APP_SERVICE_AUTHENTICATION_HEADER:"X-MSAL-APP-SERVICE-AUTHENTICATION",APP_SERVICE_ACCESS_TOKEN_HEADER:"X-MS-TOKEN-AAD-ACCESS-TOKEN",APP_SERVICE_ID_TOKEN_HEADER:"X-MS-TOKEN-AAD-ID-TOKEN",APP_SERVICE_REFRESH_TOKEN_HEADER:"X-MS-TOKEN-AAD-REFRESH-TOKEN",APP_SERVICE_ACCESS_TOKEN_EXPIRES_HEADER:"X-MS-TOKEN-AAD-EXPIRES-ON",APP_SERVICE_USER_OID_HEADER:"X-MS-CLIENT-PRINCIPAL-ID",APP_SERVICE_USER_UPN_HEADER:"X-MS-CLIENT-PRINCIPAL-NAME",APP_SERVICE_IDP_X_HEADER:"X-MS-CLIENT-PRINCIPAL-IDP"},w={GROUPS:"groups",ROLES:"roles",CLAIM_NAMES:"_claim_name",CLAIM_SOURCES:"_claim_sources",PAGINATION_LINK:"@odata.nextLink",GRAPH_MEMBERS_ENDPOINT:"https://graph.microsoft.com/v1.0/me/memberOf",GRAPH_MEMBER_SCOPES:"User.Read GroupMember.Read.All"},b="Authentication routes are not defined. Ensure that the application settings are configured properly.",C={loggerCallback:function(e,t,r){r||console.info(t)},piiLoggingEnabled:!1,logLevel:r.LogLevel.Info};!function(e){e[e.WebApp=0]="WebApp",e[e.WebApi=1]="WebApi"}(y||(y={}));var R=function(){function e(){}return e.validateAppSettings=function(t,n){var o,i;if(r.StringUtils.isEmpty(t.appCredentials.clientId))throw new Error("No clientId provided!");if(!e.isGuid(t.appCredentials.clientId))throw new Error("Invalid clientId!");if(r.StringUtils.isEmpty(t.appCredentials.tenantId))throw new Error("No tenant info provided!");if(!e.isGuid(t.appCredentials.tenantId)&&!Object.values(E).includes(t.appCredentials.tenantId))throw new Error("Invalid tenant info!");switch(n){case y.WebApp:if(r.StringUtils.isEmpty(null==(o=t.authRoutes)?void 0:o.redirect))throw new Error("No redirect URI provided!");if(r.StringUtils.isEmpty(null==(i=t.authRoutes)?void 0:i.unauthorized))throw new Error("No unauthorized route provided!")}},e.isGuid=function(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},e.getResourceNameFromScopes=function(e,t){var r=Object.values(f({},t.protectedResources,t.ownedResources)).findIndex((function(t){return JSON.stringify(t.scopes)===JSON.stringify(e)}));return Object.keys(f({},t.protectedResources,t.ownedResources))[r]},e.getScopesFromResourceEndpoint=function(e,t){var r;return(null==(r=Object.values(f({},t.protectedResources,t.ownedResources)).find((function(t){return t.endpoint===e})))?void 0:r.scopes)||[]},e.getEffectiveScopes=function(e){return e.filter((function(e){return!m.includes(e)}))},e}(),k=function(){function e(e,t){R.validateAppSettings(e,t),this.appSettings=e}var t=e.prototype;return t.withKeyVaultCredentials=function(e){return this.keyVaultCredential=e,this},t.withCustomCachePlugin=function(e){return this.customCachePlugin=e,this},e}(),A=function(){function e(e){void 0===e&&(e="aes-192-cbc"),this.algorithm=e}var t=e.prototype;return t.generateSalt=function(){return i.randomBytes(20).toString("hex")},t.createKey=function(e,t){return i.scryptSync(e,t,24)},t.encryptData=function(e,t){var r=i.randomBytes(16),n=i.createCipheriv(this.algorithm,t,r),o=n.update(e,"utf8","hex");return[r.toString("hex"),o+n.final("hex")].join(".")},t.decryptData=function(e,t){var r=e.split("."),n=r[1],o=i.createDecipheriv(this.algorithm,t,Buffer.from(r[0],"hex"));return o.update(n,"hex","utf8")+o.final("utf8")},e}(),x=function(){function e(e,t){var n;this.appSettings=e,this.msalConfig=t,this.cryptoProvider=new o.CryptoProvider,this.cryptoUtils=new A,this.logger=new r.Logger(null==(n=this.msalConfig.system)?void 0:n.loggerOptions,"@azure-samples/microsoft-identity-express","beta"),this.msalClient=new o.ConfidentialClientApplication(this.msalConfig)}var t=e.prototype;return t.getMsalClient=function(){return this.msalClient},t.getMsalConfig=function(){return this.msalConfig},t.getLogger=function(){return this.logger},e}(),T=function(){};T.callApiEndpoint=function(){var e=h(p().mark((function e(t){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,s.get(t);case 3:return e.abrupt("return",e.sent.data);case 7:throw e.prev=7,e.t0=e.catch(0),e.t0;case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t){return e.apply(this,arguments)}}(),T.callApiEndpointWithToken=function(){var e=h(p().mark((function e(t,n){var o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.StringUtils.isEmpty(n)){e.next=2;break}throw new Error("No token found");case 2:return o={headers:{Authorization:"Bearer "+n}},e.prev=3,e.next=6,s.get(t,o);case 6:return e.abrupt("return",e.sent.data);case 10:throw e.prev=10,e.t0=e.catch(3),e.t0;case 13:case"end":return e.stop()}}),e,null,[[3,10]])})));return function(t,r){return e.apply(this,arguments)}}(),T.handlePagination=function(){var e=h(p().mark((function e(t,r,n){var o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n=[]),e.prev=1,e.next=4,T.callApiEndpointWithToken(r,t);case 4:return e.next=6,e.sent.data;case 6:if((o=e.sent).value.map((function(e){return n.push(e.id)})),!o[w.PAGINATION_LINK]){e.next=14;break}return e.next=11,T.handlePagination(t,o[w.PAGINATION_LINK],n);case 11:return e.abrupt("return",e.sent);case 14:return e.abrupt("return",n);case 15:e.next=20;break;case 17:throw e.prev=17,e.t0=e.catch(1),e.t0;case 20:case"end":return e.stop()}}),e,null,[[1,17]])})));return function(t,r,n){return e.apply(this,arguments)}}();var _=function(){};_.ensureAbsoluteUrl=function(e,t){var n=new r.UrlString(t).getUrlComponents();return n.Protocol?t:n.HostNameAndPort||t.startsWith("www")?e.protocol+"://"+t:t.startsWith("/")?e.protocol+"://"+e.get("host")+t:e.protocol+"://"+e.get("host")+"/"+t},_.getPathFromUrl=function(e){return"/"+new r.UrlString(e).getUrlComponents().PathSegments.join("/")};var O=["_claim_names","_claim_sources"],I=function(e){function o(t,r){return e.call(this,t,r)||this}d(o,e);var i=o.prototype;return i.initialize=function(){var e,t=this;if(!this.appSettings.authRoutes)throw this.logger.error(b),new Error(b);var r=n.Router();return r.use((function(e,r,n){if(!e.session)throw t.logger.error("No session found for this request"),new Error("No session found for this request");n()})),r.post(_.getPathFromUrl(this.appSettings.authRoutes.redirect),this.handleRedirect()),null!=(e=this.appSettings.authRoutes)&&e.frontChannelLogout&&r.get(this.appSettings.authRoutes.frontChannelLogout,(function(e,t){e.session.destroy((function(){t.sendStatus(200)}))})),r},i.signIn=function(e){var n=this;return void 0===e&&(e={postLoginRedirect:"/",failureRedirect:"/"}),function(o,i,s){return n.redirectToAuthCodeUrl(o,i,s,{scopes:r.OIDC_DEFAULT_SCOPES},{scopes:r.OIDC_DEFAULT_SCOPES},{appStage:t.SIGN_IN,redirectTo:e.postLoginRedirect,csrfToken:o.session.csrfToken})}},i.signOut=function(e){var t=this;return void 0===e&&(e={postLogoutRedirect:"/"}),function(r,n){var o=_.ensureAbsoluteUrl(r,e.postLogoutRedirect),i=t.msalConfig.auth.authority+"/oauth2/v2.0/logout?post_logout_redirect_uri="+o;r.session.destroy((function(){n.redirect(i)}))}},i.handleRedirect=function(){var e=this;return function(){var r=h(p().mark((function r(n,o,i){var s,a,c,u,l;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(n.session.key){r.next=3;break}throw e.logger.error("No session found for this request"),new Error("No session found for this request");case 3:if(n.session.authorizationCodeRequest){r.next=6;break}throw e.logger.error("No auth code request object found in session"),new Error("No auth code request object found in session");case 6:if(e.appSettings.authRoutes){r.next=9;break}throw e.logger.error(b),new Error(b);case 9:if(!n.body.state){r.next=54;break}if((s=JSON.parse(e.cryptoUtils.decryptData(e.cryptoProvider.base64Decode(n.body.state),Buffer.from(n.session.key,"hex")))).csrfToken!==n.session.csrfToken){r.next=51;break}r.t0=s.appStage,r.next=r.t0===t.SIGN_IN?15:r.t0===t.ACQUIRE_TOKEN?31:47;break;case 15:return n.session.authorizationCodeRequest.code=n.body.code,r.prev=16,r.next=19,e.msalClient.acquireTokenByCode(n.session.authorizationCodeRequest);case 19:if(a=r.sent){r.next=22;break}throw new Error("Token response is null");case 22:n.session.isAuthenticated=!0,n.session.account=a.account,o.redirect(s.redirectTo),r.next=30;break;case 27:r.prev=27,r.t1=r.catch(16),i(r.t1);case 30:return r.abrupt("break",49);case 31:return c=R.getResourceNameFromScopes(n.session.authorizationCodeRequest.scopes,e.appSettings),n.session.authorizationCodeRequest.code=n.body.code,r.prev=33,r.next=36,e.msalClient.acquireTokenByCode(n.session.authorizationCodeRequest);case 36:if(l=r.sent){r.next=39;break}throw new Error("Token response is null");case 39:n.session.protectedResources=((u={})[c]={accessToken:l.accessToken},u),o.redirect(s.redirectTo),r.next=46;break;case 43:r.prev=43,r.t2=r.catch(33),i(r.t2);case 46:return r.abrupt("break",49);case 47:return i(new Error("Cannot determine application stage")),r.abrupt("break",49);case 49:r.next=52;break;case 51:o.redirect(e.appSettings.authRoutes.unauthorized);case 52:r.next=55;break;case 54:o.redirect(e.appSettings.authRoutes.unauthorized);case 55:case"end":return r.stop()}}),r,null,[[16,27],[33,43]])})));return function(e,t,n){return r.apply(this,arguments)}}()},i.getToken=function(e){var n=this;return function(){var o=h(p().mark((function o(i,s,a){var c,u,l,h,d;return p().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(n.appSettings.protectedResources){o.next=3;break}throw n.logger.error("No protected resource is configured to acquire a token for. Ensure that the application settings are configured properly."),new Error("No protected resource is configured to acquire a token for. Ensure that the application settings are configured properly.");case 3:return l=R.getResourceNameFromScopes(u=e.resource.scopes,n.appSettings),i.session.protectedResources=((c={})[l]=f({},n.appSettings.protectedResources[l],{accessToken:void 0}),c),o.prev=6,h={account:i.session.account,scopes:u},o.next=10,n.msalClient.acquireTokenSilent(h);case 10:if((d=o.sent)&&!r.StringUtils.isEmpty(d.accessToken)){o.next=13;break}throw new r.InteractionRequiredAuthError("interaction_required");case 13:i.session.protectedResources[l].accessToken=d.accessToken,a(),o.next=27;break;case 17:if(o.prev=17,o.t0=o.catch(6),!(o.t0 instanceof r.InteractionRequiredAuthError)){o.next=26;break}return o.abrupt("return",n.redirectToAuthCodeUrl(i,s,a,{scopes:u},{scopes:u},{appStage:t.ACQUIRE_TOKEN,redirectTo:i.originalUrl}));case 26:a(o.t0);case 27:case"end":return o.stop()}}),o,null,[[6,17]])})));return function(e,t,r){return o.apply(this,arguments)}}()},i.isAuthenticated=function(){var e=this;return function(t,r,n){if(!e.appSettings.authRoutes)throw e.logger.error(b),new Error(b);if(!t.session.isAuthenticated)return r.redirect(e.appSettings.authRoutes.unauthorized);n()}},i.hasAccess=function(e){var t=this;return function(){var r=h(p().mark((function r(n,o,i){var s,a;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t.appSettings.authRoutes){r.next=3;break}throw t.logger.error(b),new Error(b);case 3:if(t.appSettings.accessMatrix){r.next=6;break}throw t.logger.error("No access matrix is configured to control access for. Ensure that the application settings are configured properly."),new Error("No access matrix is configured to control access for. Ensure that the application settings are configured properly.");case 6:if(null!=(s=n.session.account)&&s.idTokenClaims){r.next=9;break}throw t.logger.error("No id token claims found in session"),new Error("No id token claims found in session");case 9:a=e.accessRule.hasOwnProperty(w.GROUPS)?w.GROUPS:w.ROLES,r.t0=a,r.next=r.t0===w.GROUPS?13:r.t0===w.ROLES?28:37;break;case 13:if(n.session.account.idTokenClaims[w.GROUPS]){r.next=23;break}if(!n.session.account.idTokenClaims[w.CLAIM_NAMES]&&!n.session.account.idTokenClaims[w.CLAIM_SOURCES]){r.next=20;break}return r.next=17,t.handleOverage(n,o,i,e.accessRule);case 17:return r.abrupt("return",r.sent);case 20:return r.abrupt("return",o.redirect(t.appSettings.authRoutes.unauthorized));case 21:r.next=26;break;case 23:if(t.checkAccessRule(n.method,e.accessRule,n.session.account.idTokenClaims[w.GROUPS],w.GROUPS)){r.next=26;break}return r.abrupt("return",o.redirect(t.appSettings.authRoutes.unauthorized));case 26:return i(),r.abrupt("break",38);case 28:if(n.session.account.idTokenClaims[w.ROLES]){r.next=32;break}return r.abrupt("return",o.redirect(t.appSettings.authRoutes.unauthorized));case 32:if(t.checkAccessRule(n.method,e.accessRule,n.session.account.idTokenClaims[w.ROLES],w.ROLES)){r.next=35;break}return r.abrupt("return",o.redirect(t.appSettings.authRoutes.unauthorized));case 35:return i(),r.abrupt("break",38);case 37:return r.abrupt("break",38);case 38:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}()},i.redirectToAuthCodeUrl=function(){var e=h(p().mark((function e(t,n,o,i,s,a){var c,u;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.appSettings.authRoutes){e.next=3;break}throw this.logger.error(b),new Error(b);case 3:return t.session.csrfToken=this.cryptoProvider.createNewGuid(),c=this.cryptoUtils.createKey(t.session.csrfToken,this.cryptoUtils.generateSalt()),t.session.key=c.toString("hex"),u=JSON.stringify(f({},a,{csrfToken:t.session.csrfToken})),t.session.authorizationUrlRequest=f({},i,{state:this.cryptoProvider.base64Encode(this.cryptoUtils.encryptData(u,c)),redirectUri:_.ensureAbsoluteUrl(t,this.appSettings.authRoutes.redirect),responseMode:r.ResponseMode.FORM_POST}),t.session.authorizationCodeRequest=f({},s,{redirectUri:_.ensureAbsoluteUrl(t,this.appSettings.authRoutes.redirect),code:""}),e.prev=9,e.next=12,this.msalClient.getAuthCodeUrl(t.session.authorizationUrlRequest);case 12:n.redirect(e.sent),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(9),o(e.t0);case 19:case"end":return e.stop()}}),e,this,[[9,16]])})));return function(t,r,n,o,i,s){return e.apply(this,arguments)}}(),i.handleOverage=function(){var e=h(p().mark((function e(t,r,n,o){var i,s,a,c,u;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.appSettings.authRoutes){e.next=3;break}throw this.logger.error(b),new Error(b);case 3:if(null!=(i=t.session.account)&&i.idTokenClaims){e.next=6;break}throw this.logger.error("No id token claims found in session"),new Error("No id token claims found in session");case 6:return s=g(t.session.account.idTokenClaims,O),a={account:t.session.account,scopes:w.GRAPH_MEMBER_SCOPES.split(" ")},e.prev=8,e.next=11,this.msalClient.acquireTokenSilent(a);case 11:if(c=e.sent){e.next=14;break}throw new Error("Token response is null");case 14:return e.prev=14,e.next=17,T.callApiEndpointWithToken(w.GRAPH_MEMBERS_ENDPOINT,c.accessToken);case 17:if(!(u=e.sent).data[w.PAGINATION_LINK]){e.next=36;break}return e.prev=19,e.next=22,T.handlePagination(c.accessToken,u.data[w.PAGINATION_LINK]);case 22:if(t.session.account.idTokenClaims=f({},s,{groups:e.sent}),this.checkAccessRule(t.method,o,t.session.account.idTokenClaims[w.GROUPS],w.GROUPS)){e.next=28;break}return e.abrupt("return",r.redirect(this.appSettings.authRoutes.unauthorized));case 28:return e.abrupt("return",n());case 29:e.next=34;break;case 31:e.prev=31,e.t0=e.catch(19),n(e.t0);case 34:e.next=42;break;case 36:if(t.session.account.idTokenClaims=f({},s,{groups:u.data.value.map((function(e){return e.id}))}),this.checkAccessRule(t.method,o,t.session.account.idTokenClaims[w.GROUPS],w.GROUPS)){e.next=41;break}return e.abrupt("return",r.redirect(this.appSettings.authRoutes.unauthorized));case 41:return e.abrupt("return",n());case 42:e.next=47;break;case 44:e.prev=44,e.t1=e.catch(14),n(e.t1);case 47:e.next=52;break;case 49:e.prev=49,e.t2=e.catch(8),n(e.t2);case 52:case"end":return e.stop()}}),e,this,[[8,49],[14,44],[19,31]])})));return function(t,r,n,o){return e.apply(this,arguments)}}(),i.checkAccessRule=function(e,t,r,n){if(!t.methods.includes(e))return!1;switch(n){case w.GROUPS:if(t.groups.filter((function(e){return r.includes(e)})).length<1)return!1;break;case w.ROLES:if(t.roles.filter((function(e){return r.includes(e)})).length<1)return!1}return!0},o}(x),N=function(e){function t(t,r){return e.call(this,t,r)||this}d(t,e);var o=t.prototype;return o.initialize=function(){var e=this;if(!this.appSettings.authRoutes)throw this.logger.error(b),new Error(b);var t=n.Router();return t.get(_.getPathFromUrl(this.appSettings.authRoutes.redirect),this.handleRedirect()),t.post(_.getPathFromUrl(this.appSettings.authRoutes.redirect),this.handleRedirect()),t.use((function(t,n,o){if(!t.session)throw e.logger.error("No session found for this request"),new Error("No session found for this request");if(!t.session.isAuthenticated){var i=t.headers[S.APP_SERVICE_ID_TOKEN_HEADER.toLowerCase()];if(i){var s,a=r.AuthToken.extractTokenClaims(i,e.cryptoProvider);t.session.isAuthenticated=!0,t.session.account={tenantId:a.tid,homeAccountId:a.oid+"."+a.tid,localAccountId:a.oid,environment:null==(s=a.iss)?void 0:s.split("://")[1].split("/")[0],username:a.preferred_username,name:a.name,idTokenClaims:a}}}o()})),t},o.signIn=function(e){return void 0===e&&(e={postLoginRedirect:"/",failureRedirect:"/"}),function(t,r,n){var o,i=_.ensureAbsoluteUrl(t,e.postLoginRedirect);o="https://"+process.env.WEBSITE_HOSTNAME+"/.auth/login/aad?post_login_redirect_url="+i,r.redirect(o)}},o.signOut=function(e){return void 0===e&&(e={postLogoutRedirect:"/"}),function(t,r,n){var o=_.ensureAbsoluteUrl(t,e.postLogoutRedirect),i="https://"+process.env.WEBSITE_HOSTNAME+"/.auth/logout?post_logout_redirect_uri="+o;t.session.destroy((function(){r.redirect(i)}))}},o.handleRedirect=function(){return function(){var e=h(p().mark((function e(t,r,n){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n();case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()},o.getToken=function(e){var t=this;return function(){var n=h(p().mark((function n(o,i,s){var a,c,u,l,h,d;return p().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(c=R.getResourceNameFromScopes(e.resource.scopes,t.appSettings),o.session.protectedResources||(o.session.protectedResources={}),o.session.protectedResources=((a={})[c]=f({},t.appSettings.protectedResources[c],{accessToken:void 0}),a),!(u=o.headers[S.APP_SERVICE_ACCESS_TOKEN_HEADER.toLowerCase()])){n.next=14;break}if(l=r.AuthToken.extractTokenClaims(u,t.cryptoProvider),h=null==l?void 0:l.scp.split(" "),d=R.getEffectiveScopes(h),!e.resource.scopes.every((function(e){return d.includes(e)}))){n.next=13;break}return o.session.protectedResources[c].accessToken=u,n.abrupt("return",s());case 13:return n.abrupt("return",s(new Error("No tokens found for given scopes")));case 14:case"end":return n.stop()}}),n)})));return function(e,t,r){return n.apply(this,arguments)}}()},o.isAuthenticated=function(){var e=this;return function(t,r,n){if(!t.session.isAuthenticated)return r.redirect(e.appSettings.authRoutes.unauthorized);n()}},t}(x),P=function(){function e(){}var t=e.prototype;return t.getCredentialFromKeyVault=function(){var e=h(p().mark((function e(t){var r,n,o,i,s,c,u;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=new a.DefaultAzureCredential,n={},e.t0=t.credentialType,e.next=e.t0===v.SECRET?5:e.t0===v.CERTIFICATE?16:30;break;case 5:return e.prev=5,e.next=8,this.getSecretCredential(t,r);case 8:n={type:v.SECRET,value:e.sent.value},e.next=15;break;case 12:throw e.prev=12,e.t1=e.catch(5),e.t1;case 15:return e.abrupt("break",31);case 16:return e.prev=16,e.next=19,this.getCertificateCredential(t,r);case 19:return c=e.sent,e.next=22,this.getSecretCredential(t,r);case 22:u=e.sent,n={type:v.CERTIFICATE,value:{thumbprint:null==c||null==(o=c.properties)||null==(i=o.x509Thumbprint)?void 0:i.toString(),privateKey:null==u||null==(s=u.value)?void 0:s.split("-----BEGIN CERTIFICATE-----\n")[0]}},e.next=29;break;case 26:throw e.prev=26,e.t2=e.catch(16),e.t2;case 29:case 30:return e.abrupt("break",31);case 31:return e.abrupt("return",n);case 32:case"end":return e.stop()}}),e,this,[[5,12],[16,26]])})));return function(t){return e.apply(this,arguments)}}(),t.getCertificateCredential=function(){var e=h(p().mark((function e(t,r){var n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c.CertificateClient(t.keyVaultUrl,r),e.prev=1,e.next=4,n.getCertificate(t.credentialName);case 4:return e.abrupt("return",e.sent);case 8:throw e.prev=8,e.t0=e.catch(1),e.t0;case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}(),t.getSecretCredential=function(){var e=h(p().mark((function e(t,r){var n;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new u.SecretClient(t.keyVaultUrl,r),e.prev=1,e.next=4,n.getSecret(t.credentialName);case 4:return e.abrupt("return",e.sent);case 8:throw e.prev=8,e.t0=e.catch(1),e.t0;case 11:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}(),e}(),L=function(){function e(){}return e.getMsalConfiguration=function(e){return{auth:f({clientId:e.appCredentials.clientId,authority:e.b2cPolicies?Object.entries(e.b2cPolicies)[0][1].authority:e.appCredentials.instance?"https://"+e.appCredentials.instance+"/"+e.appCredentials.tenantId:"https://"+r.Constants.DEFAULT_AUTHORITY_HOST+"/"+e.appCredentials.tenantId},e.appCredentials.hasOwnProperty("clientSecret")&&{clientSecret:e.appCredentials.clientSecret},e.appCredentials.hasOwnProperty("clientCertificate")&&{clientCertificate:e.appCredentials.clientCertificate},{knownAuthorities:e.b2cPolicies?[r.UrlString.getDomainFromUrl(Object.entries(e.b2cPolicies)[0][1].authority)]:[]}),system:{loggerOptions:e.loggerOptions?e.loggerOptions:C}}},e}(),U=function(){function e(){}return e.isProduction=function(){return!0},e.isDevelopment=function(){return!1},e.isAppServiceAuthEnabled=function(){return"True"===process.env.WEBSITE_AUTH_ENABLED},e}(),M=function(e){function t(t){return e.call(this,t,y.WebApp)||this}d(t,e);var r=t.prototype;return r.build=function(){return this.msalConfig=L.getMsalConfiguration(this.appSettings),U.isAppServiceAuthEnabled()?new N(this.appSettings,this.msalConfig):new I(this.appSettings,this.msalConfig)},r.buildAsync=function(){var e=h(p().mark((function e(){var t,r;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.keyVaultCredential){e.next=7;break}return t=new P,e.next=5,t.getCredentialFromKeyVault(this.keyVaultCredential);case 5:this.appSettings.appCredentials[(r=e.sent).type]=r.value;case 7:if(this.msalConfig=L.getMsalConfiguration(this.appSettings),!U.isAppServiceAuthEnabled()){e.next=12;break}return e.abrupt("return",new N(this.appSettings,this.msalConfig));case 12:return e.abrupt("return",new I(this.appSettings,this.msalConfig));case 13:e.next=18;break;case 15:throw e.prev=15,e.t0=e.catch(0),new Error("Cannot obtain credentials from Key Vault");case 18:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),t}(k);exports.AppServiceWebAppAuthClient=N,exports.ConfigHelper=R,exports.FetchManager=T,exports.KeyVaultManager=P,exports.MsalConfiguration=L,exports.MsalWebAppAuthClient=I,exports.WebAppAuthClientBuilder=M,exports.packageVersion="beta";
//# sourceMappingURL=microsoft-identity-express.cjs.production.min.js.map
