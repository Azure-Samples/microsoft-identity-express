<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>microsoft-identity-express</title><meta name="description" content="Documentation for microsoft-identity-express"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">microsoft-identity-express</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>microsoft-identity-express </h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#microsoft-identity-express-beta" id="microsoft-identity-express-beta" style="color: inherit; text-decoration: none;">
  <h1>microsoft-identity-express (beta)</h1>
</a>
<p><a href="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/build-test.yml"><img src="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/build-test.yml/badge.svg" alt="Build"></a>
<a href="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/e2e-test.yml"><img src="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/e2e-test.yml/badge.svg" alt="E2E"></a>
<a href="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/codeql.yml"><img src="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/codeql.yml/badge.svg" alt="Code Scanning"></a>
<a href="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/typedoc.yml"><img src="https://github.com/Azure-Samples/microsoft-identity-express/actions/workflows/typedoc.yml/badge.svg" alt="Typedoc"></a>
<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT"></a></p>
<hr>
<p>This project illustrates a simple wrapper around the <a href="https://azuread.github.io/microsoft-authentication-library-for-js/ref/classes/_azure_msal_node.confidentialclientapplication.html">ConfidentialClientApplication</a> class of the <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-node#microsoft-authentication-library-for-node-msal-node">Microsoft Authentication Library for Node.js</a> (MSAL Node), in order to streamline routine authentication tasks such as login, logout and token acquisition, as well as securing routes and controlling access. In doing so it takes inspiration from the <a href="https://github.com/AzureAD/microsoft-identity-web">Microsoft.Identity.Web</a> with respect to developer experience.</p>
<p>This is an open source project. <a href="https://github.com/Azure-Samples/microsoft-identity-express/issues/new">Suggestions</a> and <a href="https://github.com/Azure-Samples/microsoft-identity-express/blob/dev/CONTRIBUTING.md">contributions</a> are welcome!</p>
<blockquote>
<p>:mega: This project backs the tutorial: <a href="https://github.com/Azure-Samples/ms-identity-javascript-nodejs-tutorial">Enable your Node.js web app to sign-in users and call APIs with the Microsoft identity platform</a></p>
</blockquote>

<a href="#features" id="features" style="color: inherit; text-decoration: none;">
  <h2>Features</h2>
</a>
<ul>
<li>Simple API for authN/authZ with the <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-overview">Microsoft identity platform</a></li>
<li>Fetch credentials from <a href="https://docs.microsoft.com/azure/key-vault/general/basic-concepts">Azure Key Vault</a></li>
<li>Handle role-based access with Azure AD <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">App Roles</a> and <a href="https://docs.microsoft.com/azure/active-directory/fundamentals/active-directory-groups-create-azure-portal">Security Groups</a></li>
<li>(coming soon) Handle <a href="https://docs.microsoft.com/azure/active-directory/develop/v2-conditional-access-dev-guide">Conditional Access</a> and <a href="https://docs.microsoft.com/azure/active-directory/conditional-access/concept-continuous-access-evaluation">CAE</a></li>
<li>(coming soon) Run custom policies with <a href="https://docs.microsoft.com/azure/active-directory-b2c/overview">Azure AD B2C</a></li>
</ul>
<blockquote>
<p>:warning: Protected web API scenarios are currently not supported.</p>
</blockquote>

<a href="#prerequisites" id="prerequisites" style="color: inherit; text-decoration: none;">
  <h2>Prerequisites</h2>
</a>
<ul>
<li><a href="https://nodejs.org/en/">Node</a> 14 LTS or higher</li>
<li><a href="https://expressjs.com/">Express.js</a> 4.x or higher</li>
<li><a href="https://www.npmjs.com/package/@azure/msal-node">@azure/msal-node</a></li>
<li><a href="https://www.npmjs.com/package/express-session">express-session</a> (or a similar session solution)</li>
</ul>

<a href="#installation" id="installation" style="color: inherit; text-decoration: none;">
  <h2>Installation</h2>
</a>
<pre><code class="language-shell"><span class="hl-0">    npm install azure-samples/microsoft-identity-express </span>
</code></pre>
<p>or download and extract the repository <em>.zip</em> file.</p>

<a href="#build" id="build" style="color: inherit; text-decoration: none;">
  <h2>Build</h2>
</a>
<pre><code class="language-shell"><span class="hl-0">    git clone https://github.com/Azure-Samples/microsoft-identity-express.git</span><br/><span class="hl-0">    </span><span class="hl-1">cd</span><span class="hl-0"> microsoft-identity-express</span><br/><span class="hl-0">    npm install</span><br/><span class="hl-0">    npm run build</span>
</code></pre>
<blockquote>
<p>:information_source: This project is generated using <a href="https://github.com/formium/tsdx">tsdx</a>.</p>
</blockquote>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting started</h2>
</a>

<a href="#configuration" id="configuration" style="color: inherit; text-decoration: none;">
  <h3>Configuration</h3>
</a>
<ol>
<li>Initialize the wrapper in your app by providing a settings object. The object looks like the follows:</li>
</ol>
<pre><code class="language-javascript"><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">appSettings</span><span class="hl-0"> = {</span><br/><span class="hl-0">    </span><span class="hl-4">appCredentials:</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">clientId:</span><span class="hl-0"> </span><span class="hl-5">&quot;CLIENT_ID&quot;</span><span class="hl-0">, </span><span class="hl-6">// Application (client) ID on Azure AD</span><br/><span class="hl-0">        </span><span class="hl-4">tenantId:</span><span class="hl-0"> </span><span class="hl-5">&quot;TENANT_ID&quot;</span><span class="hl-0">, </span><span class="hl-6">// alt. &quot;common&quot; &quot;organizations&quot; &quot;consumers&quot;</span><br/><span class="hl-0">        </span><span class="hl-4">clientSecret:</span><span class="hl-0"> </span><span class="hl-5">&quot;CLIENT_SECRET&quot;</span><span class="hl-0"> </span><span class="hl-6">// alt. client certificate or key vault credential</span><br/><span class="hl-0">    },</span><br/><span class="hl-0">    </span><span class="hl-4">authRoutes:</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">redirect:</span><span class="hl-0"> </span><span class="hl-5">&quot;/redirect&quot;</span><span class="hl-0">, </span><span class="hl-6">// redirect path or the full URI configured on Azure AD</span><br/><span class="hl-0">        </span><span class="hl-4">unauthorized:</span><span class="hl-0"> </span><span class="hl-5">&quot;/unauthorized&quot;</span><span class="hl-0">, </span><span class="hl-6">// unauthorized access attempts will be redirected to this route</span><br/><span class="hl-0">        </span><span class="hl-4">frontChannelLogout:</span><span class="hl-0"> </span><span class="hl-5">&quot;/sso_logout&quot;</span><span class="hl-0"> </span><span class="hl-6">// front-channel logout path or the full URI configured on Azure AD</span><br/><span class="hl-0">    },</span><br/><span class="hl-0">    </span><span class="hl-4">protectedResources:</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">graphAPI:</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-4">endpoint:</span><span class="hl-0"> </span><span class="hl-5">&quot;https://graph.microsoft.com/v1.0/me&quot;</span><span class="hl-0">, </span><span class="hl-6">// Microsoft Graph API</span><br/><span class="hl-0">            </span><span class="hl-4">scopes:</span><span class="hl-0"> [</span><span class="hl-5">&quot;user.read&quot;</span><span class="hl-0">]</span><br/><span class="hl-0">        },</span><br/><span class="hl-0">        </span><span class="hl-4">armAPI:</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-4">endpoint:</span><span class="hl-0"> </span><span class="hl-5">&quot;https://management.azure.com/tenants?api-version=2020-01-01&quot;</span><span class="hl-0">, </span><span class="hl-6">// Azure Resource Manager REST API</span><br/><span class="hl-0">            </span><span class="hl-4">scopes:</span><span class="hl-0"> [</span><span class="hl-5">&quot;https://management.azure.com/user_impersonation&quot;</span><span class="hl-0">]</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span>
</code></pre>
<ol>
<li>If you are authenticating with <strong>Azure AD B2C</strong>, user-flows should be provided as well. The first item is used as default authority.</li>
</ol>
<pre><code class="language-javascript"><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">appSettings</span><span class="hl-0"> = {</span><br/><span class="hl-0">        </span><span class="hl-6">// ...</span><br/><span class="hl-0">        </span><span class="hl-4">b2cPolicies:</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-4">signUpSignIn:</span><span class="hl-0"> {</span><br/><span class="hl-0">                </span><span class="hl-4">authority:</span><span class="hl-0"> </span><span class="hl-5">&quot;https://fabrikamb2c.b2clogin.com/fabrikamb2c.onmicrosoft.com/B2C_1_susi&quot;</span><br/><span class="hl-0">            }</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">    }</span>
</code></pre>

<a href="#integration-with-expressjs" id="integration-with-expressjs" style="color: inherit; text-decoration: none;">
  <h3>Integration with Express.js</h3>
</a>
<p>Import the package and instantiate <a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html">MsalWebAppAuthClient</a> class, via the <em>WebAppAuthClientBuilder</em>, which exposes the middleware you can use in your routes. The constructor takes the settings object and an (optional) persistent cache:</p>
<pre><code class="language-javascript"><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">express</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;express&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">session</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;express-session&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">MsIdExpress</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;microsoft-identity-express&#39;</span><span class="hl-0">);</span><br/><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">settings</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;./appSettings&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">cache</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;./utils/cachePlugin&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">router</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;./routes/router&#39;</span><span class="hl-0">);</span><br/><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">SERVER_PORT</span><span class="hl-0"> = </span><span class="hl-4">process</span><span class="hl-0">.</span><span class="hl-4">env</span><span class="hl-0">.</span><span class="hl-3">PORT</span><span class="hl-0"> || </span><span class="hl-7">4000</span><span class="hl-0">;</span><br/><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">app</span><span class="hl-0"> = </span><span class="hl-1">express</span><span class="hl-0">();</span><br/><br/><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">use</span><span class="hl-0">(</span><span class="hl-1">session</span><span class="hl-0">({</span><br/><span class="hl-0">    </span><span class="hl-4">secret:</span><span class="hl-0"> </span><span class="hl-5">&#39;ENTER_YOUR_SECRET_HERE&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-4">resave:</span><span class="hl-0"> </span><span class="hl-2">false</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-4">saveUninitialized:</span><span class="hl-0"> </span><span class="hl-2">false</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-4">cookie:</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">secure:</span><span class="hl-0"> </span><span class="hl-2">false</span><span class="hl-0">, </span><span class="hl-6">// set to true on deployment</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}));</span><br/><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">msid</span><span class="hl-0"> = </span><span class="hl-2">new</span><span class="hl-0"> </span><span class="hl-4">MsIdExpress</span><span class="hl-0">.</span><span class="hl-1">WebAppAuthClientBuilder</span><span class="hl-0">(</span><span class="hl-4">appSettings</span><span class="hl-0">).</span><span class="hl-1">build</span><span class="hl-0">();</span><br/><br/><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">use</span><span class="hl-0">(</span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">initialize</span><span class="hl-0">()); </span><span class="hl-6">// initialize default routes</span><br/><br/><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">use</span><span class="hl-0">(</span><span class="hl-1">router</span><span class="hl-0">(</span><span class="hl-4">msid</span><span class="hl-0">)); </span><span class="hl-6">// use MsalWebAppAuthClient in routers downstream</span><br/><br/><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">listen</span><span class="hl-0">(</span><span class="hl-3">SERVER_PORT</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-4">console</span><span class="hl-0">.</span><span class="hl-1">log</span><span class="hl-0">(</span><span class="hl-5">`Server is listening on port </span><span class="hl-2">${</span><span class="hl-3">SERVER_PORT</span><span class="hl-2">}</span><span class="hl-5">!`</span><span class="hl-0">));</span>
</code></pre>
<p>The wrapper stores user data on <code>req.session</code> variable. Below are some of the useful variables:</p>
<ul>
<li><code>req.session.isAuthenticated</code>: indicates if user is currently authenticated (<em>boolean</em>)</li>
<li><code>req.session.account</code>: MSAL.js account object containing useful information like ID token claims (see <a href="https://azuread.github.io/microsoft-authentication-library-for-js/ref/modules/_azure_msal_common.html#accountinfo">AccountInfo</a>)</li>
<li><code>req.session.protectedResources.&lt;resourceName&gt;</code>: Contains parameters related to an Azure AD / Azure AD B2C protected resource, including raw access tokens (see <a href="https://azure-samples.github.io/microsoft-identity-express/docs/modules.html#resource">Resource</a>)</li>
</ul>

<a href="#middleware" id="middleware" style="color: inherit; text-decoration: none;">
  <h3>Middleware</h3>
</a>

<a href="#authentication" id="authentication" style="color: inherit; text-decoration: none;">
  <h4>Authentication</h4>
</a>
<p>Add <a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html#signin">signIn()</a> and <a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html#signout">signOut()</a> middleware to routes you want users to sign-in and sign-out, respectively. You will need to pass the routes for redirect after as parameters to each:</p>
<pre><code class="language-javascript"><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">express</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;express&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">appSettings</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;../appSettings&#39;</span><span class="hl-0">);</span><br/><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">mainController</span><span class="hl-0"> = </span><span class="hl-1">require</span><span class="hl-0">(</span><span class="hl-5">&#39;../controllers/mainController&#39;</span><span class="hl-0">);</span><br/><br/><span class="hl-8">module</span><span class="hl-0">.</span><span class="hl-8">exports</span><span class="hl-0"> = (</span><span class="hl-4">msid</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><br/><span class="hl-0">    </span><span class="hl-6">// initialize router</span><br/><span class="hl-0">    </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">router</span><span class="hl-0"> = </span><span class="hl-4">express</span><span class="hl-0">.</span><span class="hl-1">Router</span><span class="hl-0">();</span><br/><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/&#39;</span><span class="hl-0">, (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">, </span><span class="hl-4">next</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">redirect</span><span class="hl-0">(</span><span class="hl-5">&#39;/home&#39;</span><span class="hl-0">));</span><br/><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/home&#39;</span><span class="hl-0">, (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">, </span><span class="hl-4">next</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">render</span><span class="hl-0">(</span><span class="hl-5">&#39;home&#39;</span><span class="hl-0">, { </span><span class="hl-4">isAuthenticated:</span><span class="hl-0"> </span><span class="hl-4">req</span><span class="hl-0">.</span><span class="hl-4">session</span><span class="hl-0">.</span><span class="hl-4">isAuthenticated</span><span class="hl-0"> });</span><br/><span class="hl-0">    });</span><br/><br/><span class="hl-0">    </span><span class="hl-6">// auth routes</span><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/signin&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">signIn</span><span class="hl-0">({</span><br/><span class="hl-0">            </span><span class="hl-4">postLoginRedirect:</span><span class="hl-0"> </span><span class="hl-5">&quot;/&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">        }),</span><br/><span class="hl-0">    );</span><br/><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/signout&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">signOut</span><span class="hl-0">({</span><br/><span class="hl-0">            </span><span class="hl-4">postLogoutRedirect:</span><span class="hl-0"> </span><span class="hl-5">&quot;/&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">        }),</span><br/><span class="hl-0">    );</span><br/><br/><span class="hl-0">    </span><span class="hl-6">// unauthorized</span><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/unauthorized&#39;</span><span class="hl-0">, (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">redirect</span><span class="hl-0">(</span><span class="hl-5">&#39;/401.html&#39;</span><span class="hl-0">));</span><br/><br/><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;*&#39;</span><span class="hl-0">, (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">redirect</span><span class="hl-0">(</span><span class="hl-5">&#39;/404.html&#39;</span><span class="hl-0">));</span><br/><br/><span class="hl-0">    </span><span class="hl-9">return</span><span class="hl-0"> </span><span class="hl-4">router</span><span class="hl-0">;</span><br/><span class="hl-0">}</span>
</code></pre>

<a href="#securing-routes" id="securing-routes" style="color: inherit; text-decoration: none;">
  <h4>Securing routes</h4>
</a>
<p>Simply add the <a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html#isauthenticated">isAuthenticated()</a> middleware before the controller that serves the page you would like to secure:</p>
<pre><code class="language-javascript"><span class="hl-6">// secure routes</span><br/><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/id&#39;</span><span class="hl-0">, </span><br/><span class="hl-0">    </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">isAuthenticated</span><span class="hl-0">(), </span><span class="hl-6">// checks if authenticated via session</span><br/><span class="hl-0">    (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">, </span><span class="hl-4">next</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">render</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">, { </span><span class="hl-4">isAuthenticated:</span><span class="hl-0"> </span><span class="hl-4">req</span><span class="hl-0">.</span><span class="hl-4">session</span><span class="hl-0">.</span><span class="hl-4">isAuthenticated</span><span class="hl-0">, </span><span class="hl-4">claims:</span><span class="hl-0"> </span><span class="hl-4">req</span><span class="hl-0">.</span><span class="hl-4">session</span><span class="hl-0">.</span><span class="hl-4">account</span><span class="hl-0">.</span><span class="hl-4">idTokenClaims</span><span class="hl-0"> });</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">);</span>
</code></pre>

<a href="#acquiring-tokens" id="acquiring-tokens" style="color: inherit; text-decoration: none;">
  <h4>Acquiring tokens</h4>
</a>
<p><a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html#gettoken">getToken()</a> can be used before middleware that calls a web API. The access token will be available via <code>req.session</code>:</p>
<pre><code class="language-javascript"><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&#39;/profile&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">isAuthenticated</span><span class="hl-0">(),</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">getToken</span><span class="hl-0">({</span><br/><span class="hl-0">            </span><span class="hl-4">resource:</span><span class="hl-0"> {</span><br/><span class="hl-0">                </span><span class="hl-4">endpoint:</span><span class="hl-0"> </span><span class="hl-5">&quot;https://graph.microsoft.com/v1.0/me&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">                </span><span class="hl-4">scopes:</span><span class="hl-0"> [ </span><span class="hl-5">&quot;User.Read&quot;</span><span class="hl-0"> ]</span><br/><span class="hl-0">            }</span><br/><span class="hl-0">        }),</span><br/><span class="hl-0">        </span><span class="hl-2">async</span><span class="hl-0">(</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">, </span><span class="hl-4">next</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> {        </span><br/><span class="hl-0">            </span><span class="hl-9">try</span><span class="hl-0"> {</span><br/><span class="hl-0">                </span><span class="hl-6">// use axios or a similar alternative</span><br/><span class="hl-0">                </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-3">response</span><span class="hl-0"> = </span><span class="hl-9">await</span><span class="hl-0"> </span><span class="hl-4">axios</span><span class="hl-0">.</span><span class="hl-4">default</span><span class="hl-0">.</span><span class="hl-1">get</span><span class="hl-0">(</span><span class="hl-5">&quot;https://graph.microsoft.com/v1.0/me&quot;</span><span class="hl-0">, {</span><br/><span class="hl-0">                    </span><span class="hl-4">headers:</span><span class="hl-0"> {</span><br/><span class="hl-0">                        </span><span class="hl-4">Authorization:</span><span class="hl-0"> </span><span class="hl-5">`Bearer </span><span class="hl-2">${</span><span class="hl-4">req</span><span class="hl-10">.</span><span class="hl-4">session</span><span class="hl-10">[</span><span class="hl-5">&quot;graphAPI&quot;</span><span class="hl-10">].</span><span class="hl-4">accessToken</span><span class="hl-2">}</span><span class="hl-5">`</span><br/><span class="hl-0">                    }</span><br/><span class="hl-0">                });</span><br/><br/><span class="hl-0">                </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">render</span><span class="hl-0">(</span><span class="hl-5">&#39;profile&#39;</span><span class="hl-0">, { </span><span class="hl-4">isAuthenticated:</span><span class="hl-0"> </span><span class="hl-4">req</span><span class="hl-0">.</span><span class="hl-4">session</span><span class="hl-0">.</span><span class="hl-4">isAuthenticated</span><span class="hl-0">, </span><span class="hl-4">profile:</span><span class="hl-0"> </span><span class="hl-4">response</span><span class="hl-0">.</span><span class="hl-4">data</span><span class="hl-0"> });</span><br/><span class="hl-0">            } </span><span class="hl-9">catch</span><span class="hl-0"> (</span><span class="hl-4">error</span><span class="hl-0">) {</span><br/><span class="hl-0">                </span><span class="hl-4">console</span><span class="hl-0">.</span><span class="hl-1">log</span><span class="hl-0">(</span><span class="hl-4">error</span><span class="hl-0">);</span><br/><span class="hl-0">                </span><span class="hl-1">next</span><span class="hl-0">(</span><span class="hl-4">error</span><span class="hl-0">);</span><br/><span class="hl-0">            }</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">    ); </span><span class="hl-6">// get token for this route to call web API</span>
</code></pre>

<a href="#controlling-access" id="controlling-access" style="color: inherit; text-decoration: none;">
  <h4>Controlling access</h4>
</a>
<p>Use <a href="https://azure-samples.github.io/microsoft-identity-express/classes/msalwebappauthclient.html#hasaccess">hasAccess()</a> middleware to control access for Azure AD App Roles and/or Security Groups:</p>
<pre><code class="language-javascript"><span class="hl-0">    </span><span class="hl-4">router</span><span class="hl-0">.</span><span class="hl-1">use</span><span class="hl-0">(</span><span class="hl-5">&#39;/admin&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">isAuthenticated</span><span class="hl-0">(),</span><br/><span class="hl-0">        </span><span class="hl-4">msid</span><span class="hl-0">.</span><span class="hl-1">hasAccess</span><span class="hl-0">({</span><br/><span class="hl-0">            </span><span class="hl-4">accessRule:</span><span class="hl-0"> {</span><br/><span class="hl-0">                </span><span class="hl-4">methods:</span><span class="hl-0"> [ </span><span class="hl-5">&quot;GET&quot;</span><span class="hl-0">, </span><span class="hl-5">&quot;POST&quot;</span><span class="hl-0">, </span><span class="hl-5">&quot;DELETE&quot;</span><span class="hl-0"> ],</span><br/><span class="hl-0">                </span><span class="hl-4">roles:</span><span class="hl-0"> [ </span><span class="hl-5">&quot;admin_role&quot;</span><span class="hl-0"> ]</span><br/><span class="hl-0">            }</span><br/><span class="hl-0">        }),</span><br/><span class="hl-0">        (</span><span class="hl-4">req</span><span class="hl-0">, </span><span class="hl-4">res</span><span class="hl-0">) </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-4">res</span><span class="hl-0">.</span><span class="hl-1">render</span><span class="hl-0">(</span><span class="hl-5">&#39;dashboard&#39;</span><span class="hl-0">, { </span><span class="hl-4">isAuthenticated:</span><span class="hl-0"> </span><span class="hl-4">req</span><span class="hl-0">.</span><span class="hl-4">session</span><span class="hl-0">.</span><span class="hl-4">isAuthenticated</span><span class="hl-0"> });</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">    );</span>
</code></pre>

<a href="#remarks" id="remarks" style="color: inherit; text-decoration: none;">
  <h2>Remarks</h2>
</a>

<a href="#session-support" id="session-support" style="color: inherit; text-decoration: none;">
  <h3>Session support</h3>
</a>
<p>Session support in this sample is provided by the <a href="https://www.npmjs.com/package/express-session">express-session</a> package using in-memory session store. <strong>in-memory session store</strong> is unfit for production, and you should either use a <a href="https://github.com/expressjs/session#compatible-session-stores">compatible session store</a> or implement your own storage solution.</p>

<a href="#persistent-caching" id="persistent-caching" style="color: inherit; text-decoration: none;">
  <h3>Persistent caching</h3>
</a>
<p>MSAL Node has an in-memory cache by default. This is not meant to be production-ready. As such, you might want to implement persistent caching using a 3rd party library like <a href="https://redis.io/">redis</a>.</p>

<a href="#information" id="information" style="color: inherit; text-decoration: none;">
  <h2>Information</h2>
</a>
<ul>
<li><a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-node/docs/initialize-confidential-client-application.md">Initializing a confidential client app with MSAL Node</a></li>
<li><a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-node/docs/configuration.md">MSAL Node Configuration options</a></li>
<li><a href="https://docs.microsoft.com/azure/active-directory/develop/scenario-web-app-call-api-overview">Scenario: A web app that calls web APIs</a></li>
</ul>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-class"><a href="classes/AppServiceWebAppAuthClient.html" class="tsd-kind-icon">App<wbr/>Service<wbr/>Web<wbr/>App<wbr/>Auth<wbr/>Client</a></li><li class="tsd-kind-class"><a href="classes/ConfigHelper.html" class="tsd-kind-icon">Config<wbr/>Helper</a></li><li class="tsd-kind-class"><a href="classes/FetchManager.html" class="tsd-kind-icon">Fetch<wbr/>Manager</a></li><li class="tsd-kind-class"><a href="classes/KeyVaultManager.html" class="tsd-kind-icon">Key<wbr/>Vault<wbr/>Manager</a></li><li class="tsd-kind-class"><a href="classes/MsalConfiguration.html" class="tsd-kind-icon">Msal<wbr/>Configuration</a></li><li class="tsd-kind-class"><a href="classes/MsalWebAppAuthClient.html" class="tsd-kind-icon">Msal<wbr/>Web<wbr/>App<wbr/>Auth<wbr/>Client</a></li><li class="tsd-kind-class"><a href="classes/WebAppAuthClientBuilder.html" class="tsd-kind-icon">Web<wbr/>App<wbr/>Auth<wbr/>Client<wbr/>Builder</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AccessRule" class="tsd-kind-icon">Access<wbr/>Rule</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AccessTokenClaims" class="tsd-kind-icon">Access<wbr/>Token<wbr/>Claims</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AppCredentials" class="tsd-kind-icon">App<wbr/>Credentials</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AppSettings" class="tsd-kind-icon">App<wbr/>Settings</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AppState" class="tsd-kind-icon">App<wbr/>State</a></li><li class="tsd-kind-type-alias"><a href="modules.html#AuthRoutes" class="tsd-kind-icon">Auth<wbr/>Routes</a></li><li class="tsd-kind-type-alias"><a href="modules.html#ClientCertificate" class="tsd-kind-icon">Client<wbr/>Certificate</a></li><li class="tsd-kind-type-alias"><a href="modules.html#GuardOptions" class="tsd-kind-icon">Guard<wbr/>Options</a></li><li class="tsd-kind-type-alias"><a href="modules.html#IdTokenClaims" class="tsd-kind-icon">Id<wbr/>Token<wbr/>Claims</a></li><li class="tsd-kind-type-alias"><a href="modules.html#KeyVaultCredential" class="tsd-kind-icon">Key<wbr/>Vault<wbr/>Credential</a></li><li class="tsd-kind-type-alias"><a href="modules.html#Policy" class="tsd-kind-icon">Policy</a></li><li class="tsd-kind-type-alias"><a href="modules.html#Resource" class="tsd-kind-icon">Resource</a></li><li class="tsd-kind-type-alias"><a href="modules.html#SignInOptions" class="tsd-kind-icon">Sign<wbr/>In<wbr/>Options</a></li><li class="tsd-kind-type-alias"><a href="modules.html#SignOutOptions" class="tsd-kind-icon">Sign<wbr/>Out<wbr/>Options</a></li><li class="tsd-kind-type-alias"><a href="modules.html#TokenRequestOptions" class="tsd-kind-icon">Token<wbr/>Request<wbr/>Options</a></li><li class="tsd-kind-type-alias"><a href="modules.html#WebAppSettings" class="tsd-kind-icon">Web<wbr/>App<wbr/>Settings</a></li><li class="tsd-kind-variable"><a href="modules.html#packageVersion" class="tsd-kind-icon">package<wbr/>Version</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited property</span></li><li class="tsd-kind-method tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li><li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-method tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>